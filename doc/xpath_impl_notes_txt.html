<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>xpath_impl_notes - XML::Mapping -- Simple, extensible Ruby-to-XML (and back) mapper</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../README_md.html">README</a>
  
    <li><a href="../TODO_txt.html">TODO</a>
  
    <li><a href="../doc/xpath_impl_notes_txt.html">xpath_impl_notes</a>
  
    <li><a href="../user_manual_md.html">user_manual</a>
  
    <li><a href="../user_manual_xxpath_md.html">user_manual_xxpath</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page doc/xpath_impl_notes.txt">

<h3 id="label-latest+design+-2812-2F2004-29">latest design (12/2004)<span><a href="#label-latest+design+-2812-2F2004-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>At the lowest level, the “Accessors” sub-module contains reader and creator
functions that correspond to the various types of path elements
(<em>elt_name</em>, @<em>attr_name</em>, <em><a
href="@attr_name='attr_value'">elt_name</a></em> etc.) that xml-xxpath
supports. A reader function gets an array of nodes and the search
parameters corresponding to its path element type (e.g. <em>elt_name</em>,
<em>attr_name</em>, <em>attr_value</em>) and returns an array with all
matching direct sub-nodes of any of the supplied nodes. A creator function
gets one node and the search parameters and returns the created sub-node.</p>

<p>An XPath expression
<code>&lt;things1&gt;/&lt;things2&gt;/.../&lt;thingsx&gt;</code> is
compiled into a bunch of nested closures, each of which is responsible for
a specific path element and calls the corresponding accessor function:</p>
<ul><li>
<p><code>@creator_procs</code> – an array of “creator” functions.
<code>@creator_procs[i]</code> gets passed a base node (XML element) and a
create_new flag, and it creates the path
<code>&lt;things[x-i+1]&gt;/&lt;things[x-i+2]&gt;/.../&lt;thingsx&gt;</code>
inside the base node and returns the hindmost element created (i.e. the one
corresponding to <code>&lt;thingsx&gt;</code>).</p>
</li><li>
<p><code>@reader_proc</code> – a “reader” function that gets passed an array
of nodes and returns an array of all nodes that matched the path in any of
the supplied nodes, or, if no match was found, throws :not_found along with
the last non-empty set of nodes that was found, and the element of
<code>@creator_procs</code> that could be used to create the remaining part
of the path.</p>
</li></ul>

<p>The <code>all</code> function is then trivially implemented on top of this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">all</span>(<span class="ruby-identifier">node</span>,<span class="ruby-identifier">options</span>={})
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;options not a hash&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Hash</span><span class="ruby-operator">===</span><span class="ruby-identifier">options</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">create_new</span>]
    <span class="ruby-keyword">return</span> [ <span class="ruby-ivar">@creator_procs</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">node</span>,<span class="ruby-keyword">true</span>) ]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">last_nodes</span>,<span class="ruby-identifier">rest_creator</span> = <span class="ruby-identifier">catch</span>(:<span class="ruby-identifier">not_found</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">return</span> <span class="ruby-ivar">@reader_proc</span>.<span class="ruby-identifier">call</span>([<span class="ruby-identifier">node</span>])
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">ensure_created</span>]
      [ <span class="ruby-identifier">rest_creator</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">last_nodes</span>[<span class="ruby-value">0</span>],<span class="ruby-keyword">false</span>) ]
    <span class="ruby-keyword">else</span>
      []
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>…and <code>first</code>, <code>create_new</code> etc. are even more trivial
frontends to that.</p>

<p>The implementations of the <code>@creator_procs</code> look like this:</p>

<pre>@creator_procs[0] =
  proc{|node,create_new| node}

@creator_procs[1] =
  proc {|node,create_new|
    @creator_procs[0].call(Accessors.create_subnode_by_&lt;thingsx&gt;(node,create_new,&lt;thingsx&gt;),
                           create_new)
  }

@creator_procs[2] =
  proc {|node,create_new|
    @creator_procs[1].call(Accessors.create_subnode_by_&lt;thingsx-1&gt;(node,create_new,&lt;thingsx-1&gt;),
                           create_new)
  }

...

@creator_procs[n] =
  proc {|node,create_new|
    @creator_procs[n-1].call(Accessors.create_subnode_by_&lt;things[x+1-n]&gt;(node,create_new,&lt;things[x+1-n]&gt;),
                             create_new)
  }

...
@creator_procs[x] =
  proc {|node,create_new|
    @creator_procs[x-1].call(Accessors.create_subnode_by_&lt;things1&gt;(node,create_new,&lt;things1&gt;),
                             create_new)
  }</pre>

<p>..and the implementation of @reader_proc looks like this:</p>

<pre>@reader_proc = rpx where

rp0 = proc {|nodes| nodes}

rp1 = proc {|nodes|
              next_nodes = Accessors.subnodes_by_&lt;thingsx&gt;(nodes,&lt;thingsx&gt;)
              if (next_nodes == [])
                throw :not_found, [nodes,@creator_procs[1]]
              else
                rp0.call(next_nodes)
              end
            }

rp2 = proc {|nodes|
              next_nodes = Accessors.subnodes_by_&lt;thingsx-1&gt;(nodes,&lt;thingsx-1&gt;)
              if (next_nodes == [])
                throw :not_found, [nodes,@creator_procs[2]]
              else
                rp1.call(next_nodes)
              end
            }
...

rpx = proc {|nodes|
              next_nodes = Accessors.subnodes_by_&lt;things1&gt;(nodes,&lt;things1&gt;)
              if (next_nodes == [])
                throw :not_found, [nodes,@creator_procs[x]]
              else
                rpx-1.call(next_nodes)
              end
            }</pre>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

